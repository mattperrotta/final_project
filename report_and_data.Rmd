---
title: "Data"
author: "Zach Keefer"
date: "12/3/2018"
output: html_document
---

### Load Packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(readxl)
library(patchwork)
library(devtools)
#install_github("kmcconeghy/flumodelr")
library(flumodelr)
```


# Reading and Cleaning the Data

Function to read in multiple CSV files
```{r}
#Files were too large to query all at once
file_df = tibble(file_path = list.files('./data/', pattern = '*.csv', full.names = TRUE), file_name = basename(file_path))

read_data = function(data){
  
  read_csv(file = data, skip = 3)
  
}

flu_df = file_df %>%
  mutate(obs = map(file_path, read_data))
```

Binding the data rows
```{r}
flu_df = flu_df %>%
  unnest() %>% 
  janitor::clean_names() %>% 
  ##Creating an epiweek variable that is ordinal
  mutate(week = as.character(week),
         week = ifelse(week == "1", "01", week),
         week = ifelse(week == "2", "02", week),
         week = ifelse(week == "3", "03", week),
         week = ifelse(week == "4", "04", week),
         week = ifelse(week == "5", "05", week),
         week = ifelse(week == "6", "06", week),
         week = ifelse(week == "7", "07", week),
         week = ifelse(week == "8", "08", week),
         week = ifelse(week == "9", "09", week),
         epiweek = str_c(year, week, sep = "."),
         epiweek = as.numeric(epiweek)) 
```

Tidy flu data set to use for visualizations
```{r}
tidy_flu = flu_df %>% 
  mutate(year = as.factor(year),
         week = as.numeric(week)) %>% 
  group_by(fluregion, epiweek, year, week, edate) %>% 
  summarize(cases = sum(all_inf, na.rm = TRUE),
            h1 = sum(ah1, na.rm = TRUE),
            h3 = sum(ah3, na.rm = TRUE),
            h5 = sum(ah5, na.rm = TRUE),
            h1n1 = sum(ah1n12009, na.rm = TRUE),
            a_total = sum(inf_a, na.rm = TRUE),
            b_total = sum(inf_b, na.rm = TRUE),
            processed_samples = sum(spec_processed_nb, na.rm = TRUE),
            inf_a_prop = sum(inf_a, na.rm = TRUE)/sum(spec_processed_nb, na.rm = TRUE),
            inf_b_prop = sum(inf_b, na.rm = TRUE)/sum(spec_processed_nb, na.rm = TRUE))
```

Creation of dataset to bind demographic data
```{r}
countries = flu_df %>% 
  group_by(fluregion, country) %>% 
  summarize(infections = sum(all_inf))
```

Reading in and cleaning demographic data
```{r}
#Number of Arrivals
arrival_df = read_excel("./data/arrival_data.xls", skip = 3) %>% 
  janitor::clean_names() %>% 
  select(country, country_code, x2008:x2014) %>% 
  gather(key = year, value = arrivals, x2008:x2014) %>% 
  group_by(country) %>% 
  summarize(mean_arrival = mean(arrivals))

#Population
pop_df = read_excel("./data/pop_data.xls", skip = 3) %>% 
  janitor::clean_names() %>% 
  select(country, country_code, x2008:x2014) %>% 
  gather(key = year, value = pop, x2008:x2014) %>% 
  group_by(country) %>% 
  summarize(mean_pop = mean(pop))

#Doctors per 100,000
drs_df = read_excel("./data/dr_per_100k_data.xls") %>% 
  janitor::clean_names() %>% 
  mutate(drs_per_100k = as.numeric(drs_per_100k)) %>% 
  group_by(country) %>% 
  summarize(drs = mean(drs_per_100k))
```

Joining and tidying of demographic data
```{r}
country_demo = left_join(countries, pop_df, by = "country")

country_demo = left_join(country_demo, arrival_df, by = "country")

country_demo = left_join(country_demo, drs_df, by = "country")

flu_region_demo = country_demo %>% 
  group_by(fluregion) %>% 
  summarize(infections = sum(infections),
            population = sum(mean_pop, na.rm = TRUE),
            arrivals = sum(mean_arrival, na.rm = TRUE),
            drs_per_100k = mean(drs, na.rm = TRUE))
```

Joining flu and demographic data
```{r}
flu_demo_df = left_join(tidy_flu, flu_region_demo, by = "fluregion") %>% 
  mutate(cases_by_1k = (cases*1000)/population)
```


```{r}
flu_demo_df %>% 
  ggplot(aes(x = epiweek, y = cases_by_1k)) +
  geom_line() +
  facet_wrap(~ fluregion)
```



```{r}
tidy_flu_2 = flu_df %>% 
  mutate(week = as.numeric(week),
         year = as.factor(year)) %>% 
  group_by(fluregion, year, week) %>% 
    summarize(cases = sum(all_inf),
            h1 = sum(ah1),
            h3 = sum(ah3),
            h5 = sum(ah5),
            h1n1 = sum(ah1n12009),
            a_total = sum(inf_a),
            b_total = sum(inf_b)) %>% 
  left_join(flu_region_demo, by = "fluregion") %>% 
  mutate(cases_by_1k = (cases*1000)/population)

tidy_flu_2 %>% 
  ggplot(aes(x = week, y = cases_by_1k, color = year)) +
  geom_line() +
  facet_wrap(~ fluregion)
  
```

The zones with the most complete data are North America, Northern Europe, Oceania Melanesia Polynesia, and Temperate South America

```{r}
#Filter flu data for zones of interest
tidy_flu_3 = tidy_flu_2 %>% 
  filter(fluregion %in% c('North America', 'Northern Europe', 'Oceania Melanesia Polynesia', 'Temperate South America', 'Eastern Asia')) 

tidy_flu_3 %>% 
  ggplot(aes(x = week, y = cases_by_1k, color = year)) +
  geom_line() +
  facet_wrap(~ fluregion)
```

Looking at distribution of influenza types and subtypes
```{r}
NoAm = tidy_flu_3 %>% 
  filter(fluregion == 'North America') %>% 
  ggplot() +
  geom_line(aes(x = week, y = h1n1, color = 'H1')) +
  geom_line(aes(x = week, y = h3, color = 'H3')) +
  geom_line(aes(x = week, y = h5, color = 'H5')) + 
  geom_line(aes(x = week, y = b_total, color = 'Type B')) +
  facet_grid(~ year) +
  labs(
    title = 'North America',
    y = 'Cases'
  )

NoEu = tidy_flu_3 %>% 
  filter(fluregion == 'Northern Europe') %>% 
  ggplot() +
  geom_line(aes(x = week, y = h1n1, color = 'H1')) +
  geom_line(aes(x = week, y = h3, color = 'H3')) +
  geom_line(aes(x = week, y = h5, color = 'H5')) +
  geom_line(aes(x = week, y = b_total, color = 'Type B')) +
  facet_grid(~ year) +
  labs(
    title = 'Northern Europe',
    y = 'Cases'
  )

OMP = tidy_flu_3 %>% 
  filter(fluregion == 'Oceania Melanesia Polynesia') %>% 
  ggplot() +
  geom_line(aes(x = week, y = h1n1, color = 'H1')) +
  geom_line(aes(x = week, y = h3, color = 'H3')) +
  geom_line(aes(x = week, y = h5, color = 'H5')) +
  geom_line(aes(x = week, y = b_total, color = 'Type B')) +
  facet_grid(~ year) +
  labs(
    title = 'Oceania Melanesia Polynesia',
    y = 'Cases'
  )

TSA = tidy_flu_3 %>% 
  filter(fluregion == 'Temperate South America') %>% 
  ggplot() +
  geom_line(aes(x = week, y = h1n1, color = 'H1')) +
  geom_line(aes(x = week, y = h3, color = 'H3')) +
  geom_line(aes(x = week, y = h5, color = 'H5')) +
  geom_line(aes(x = week, y = b_total, color = 'Type B')) +
  facet_grid(~ year) +
  labs(
    title = 'Temperate South America',
    y = 'Cases'
  )

EaAs = tidy_flu_3 %>% 
  filter(fluregion == 'Eastern Asia') %>% 
  ggplot() +
  geom_line(aes(x = week, y = h1n1, color = 'H1')) +
  geom_line(aes(x = week, y = h3, color = 'H3')) +
  geom_line(aes(x = week, y = h5, color = 'H5')) +
  geom_line(aes(x = week, y = b_total, color = 'Type B')) +
  facet_grid(~ year) +
  labs(
    title = 'Eastern Asia',
    y = 'Cases'
  )

NoAm / NoEu / OMP / TSA / EaAs
```


Creating an epidemic threshold line


Attempt at serfling regression and epidemic threshold
```{r}
flu_data <- tidy_flu %>% 
  mutate(theta = 2*week/52,
         sin_f1 = sinpi(theta),
         cos_f1 = cospi(theta),
         week_2 = week^2,
         week_3 = week^3,
         week_4 = week^4,
         week_5 = week^5)

base_fit <- flu_data %>%
  filter(fluregion == 'North America') %>% 
  lm(a_total ~ week + week_2 + week_3 + week_4 + week_5 +
       inf_a_prop + sin_f1 + cos_f1, data = ., na.action = na.exclude)

base_pred <- flu_data %>%
  mutate(inf_a_prop = 0) %>%
  predict(base_fit, newdata = ., se.fit = TRUE, 
          interval = 'prediction', level = 0.95)

flu_fitted <- flu_data %>%
  add_column(y0 = base_pred$fit[,1], y0_ul = base_pred$fit[,3])
```

```{r}
flu = flu_fitted %>% 
  mutate(week = as.numeric(week))
flu_fitted %>% 
  filter(year == '2008') %>% 
  ggplot() +
  geom_line(aes(x = week, y = a_total, color = 'Inf A Cases')) +
  geom_line(aes(x = week, y = y0_ul, color = 'Epi Threshold')) +
  geom_line(aes(x = week, y = y0, color = 'Expected')) +
  geom_line(aes(x = week, y = h1n1, color = 'H1')) +
  geom_line(aes(x = week, y = h3, color = 'H3')) +
  geom_line(aes(x = week, y = h5, color = 'H5')) +
  facet_grid(~ year)
```
```{r}
flu_fitted %>% 
  ggplot(aes(x = ))
```

