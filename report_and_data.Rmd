---
title: "Data"
author: "Zach Keefer"
date: "12/3/2018"
output: html_document
---

The primary objective of this project and endeavour is to explore the tools necessary to work in the intersection of infectious disease epidemiology modeling and data science. In fact, the four team members are a part of Mailman’s Infectious Disease Epidemiology Concentration.

In exploring project ideas, we discussed feasability through the lens of data availability and our current knowledge of the field. The following includes some of our preliminary findings.

Last year, in 2018, nearly 80,000 people died from the flu in the US alone according to this CNN article. In fact, many scholars argue that there is an impending ‘global threat of avian flu’ due to rapid globalization and urbanization.

We find that understanding current patterns and trends of flu would be useful to build stronger epidemiological frameworks for disease surveillance and emergency preparedness. Specifically, we wanted to examime the seasonality of inlfuenza in different regions in the world using country level influenza data.

### Load Packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(readxl)
library(patchwork)
library(devtools)
```


# Reading and Cleaning the Data

Function to read in multiple CSV files
```{r message = FALSE, warning = FALSE}
#Files were too large to query all at once
file_df = tibble(file_path = list.files('./data/', pattern = '*.csv', full.names = TRUE), file_name = basename(file_path))

read_data = function(data){
  
  read_csv(file = data, skip = 3)
  
}

flu_df = file_df %>%
  mutate(obs = map(file_path, read_data)) %>% 
  unnest() %>% 
  janitor::clean_names() %>% 
  mutate(year = as.factor(year),
         week = as.numeric(week),
         date = edate) %>% 
  group_by(fluregion, year, week, date) %>% 
  summarize(cases = sum(all_inf, na.rm = TRUE),
            h1 = sum(ah1, na.rm = TRUE),
            h3 = sum(ah3, na.rm = TRUE),
            h5 = sum(ah5, na.rm = TRUE),
            h1n1 = sum(ah1n12009, na.rm = TRUE),
            a_total = sum(inf_a, na.rm = TRUE),
            b_total = sum(inf_b, na.rm = TRUE),
            processed_samples = sum(spec_processed_nb, na.rm = TRUE),
            inf_a_prop = sum(inf_a, na.rm = TRUE)/sum(spec_processed_nb, na.rm = TRUE),
            inf_b_prop = sum(inf_b, na.rm = TRUE)/sum(spec_processed_nb, na.rm = TRUE))
```

Read in population data
```{r}
pop_df = read_excel("./data/pop_data.xls", skip = 3) %>% 
  janitor::clean_names() %>% 
  select(country, country_code, x2008:x2014) %>% 
  gather(key = year, value = pop, x2008:x2014) %>% 
  group_by(country) %>% 
  summarize(mean_pop = mean(pop))
```

Join `flu_df` and `pop_df`
```{r message = FALSE, warning = FALSE}
countries = file_df %>%
  mutate(obs = map(file_path, read_data)) %>% 
  unnest() %>% 
  janitor::clean_names() %>%
  select(country, fluregion)

demo = left_join(countries, pop_df, by = 'country') %>% 
  group_by(fluregion) %>% 
  summarize(pop = sum(mean_pop, na.rm = TRUE))

flu_df = left_join(flu_df, demo, by = 'fluregion') %>% 
  mutate(cases_by_100k = (cases*100000)/pop)
```

# Exploratory Analysis

```{r}
flu_df %>%
  group_by(year) %>% 
  summarize(type_a = sum(a_total),
            type_b = sum(b_total)) %>% 
  gather(key = type, value = count, type_a:type_b) %>% 
  ggplot(aes(x = year, y = count, fill = factor(type))) +
  geom_bar(stat = 'identity', position = 'dodge')
```

```{r}
flu_df %>%
  group_by(year) %>% 
  summarize(h1n1 = sum(h1n1),
            h3 = sum(h3),
            h5 = sum(h5)) %>% 
  gather(key = subtype, value = count, h1n1:h5) %>% 
  ggplot(aes(x = year, y = count, fill = factor(subtype))) +
  geom_bar(stat = 'identity', position = 'dodge')
```

```{r}
flu_df %>% 
  ggplot(aes(x = week, y = cases_by_100k, color = year)) +
  geom_line() +
  facet_wrap(~ fluregion)
```

The zones with the most complete data are North America, Northern Europe, Oceania Melanesia Polynesia, and Temperate South America.  We also decided to include Eastern Asia in our analysis because it included China and South Africa.


Looking at distribution of influenza types and subtypes
```{r}
NoAm = flu_df %>% 
  filter(fluregion == 'North America') %>% 
  ggplot() +
  geom_line(aes(x = week, y = h1n1, color = 'H1')) +
  geom_line(aes(x = week, y = h3, color = 'H3')) +
  geom_line(aes(x = week, y = h5, color = 'H5')) + 
  geom_line(aes(x = week, y = b_total, color = 'Type B')) +
  facet_grid(~ year) +
  labs(
    title = 'North America',
    y = 'Cases'
  )

NoEu = flu_df %>% 
  filter(fluregion == 'Northern Europe') %>% 
  ggplot() +
  geom_line(aes(x = week, y = h1n1, color = 'H1')) +
  geom_line(aes(x = week, y = h3, color = 'H3')) +
  geom_line(aes(x = week, y = h5, color = 'H5')) +
  geom_line(aes(x = week, y = b_total, color = 'Type B')) +
  facet_grid(~ year) +
  labs(
    title = 'Northern Europe',
    y = 'Cases'
  )

OMP = flu_df %>% 
  filter(fluregion == 'Oceania Melanesia Polynesia') %>% 
  ggplot() +
  geom_line(aes(x = week, y = h1n1, color = 'H1')) +
  geom_line(aes(x = week, y = h3, color = 'H3')) +
  geom_line(aes(x = week, y = h5, color = 'H5')) +
  geom_line(aes(x = week, y = b_total, color = 'Type B')) +
  facet_grid(~ year) +
  labs(
    title = 'Oceania Melanesia Polynesia',
    y = 'Cases'
  )

TSA = flu_df %>% 
  filter(fluregion == 'Temperate South America') %>% 
  ggplot() +
  geom_line(aes(x = week, y = h1n1, color = 'H1')) +
  geom_line(aes(x = week, y = h3, color = 'H3')) +
  geom_line(aes(x = week, y = h5, color = 'H5')) +
  geom_line(aes(x = week, y = b_total, color = 'Type B')) +
  facet_grid(~ year) +
  labs(
    title = 'Temperate South America',
    y = 'Cases'
  )

EaAs = flu_df %>% 
  filter(fluregion == 'Eastern Asia') %>% 
  ggplot() +
  geom_line(aes(x = week, y = h1n1, color = 'H1')) +
  geom_line(aes(x = week, y = h3, color = 'H3')) +
  geom_line(aes(x = week, y = h5, color = 'H5')) +
  geom_line(aes(x = week, y = b_total, color = 'Type B')) +
  facet_grid(~ year) +
  labs(
    title = 'Eastern Asia',
    y = 'Cases'
  )

SA = flu_df %>% 
  filter(fluregion == 'Southern Africa') %>% 
  ggplot() +
  geom_line(aes(x = week, y = h1n1, color = 'H1')) +
  geom_line(aes(x = week, y = h3, color = 'H3')) +
  geom_line(aes(x = week, y = h5, color = 'H5')) +
  geom_line(aes(x = week, y = b_total, color = 'Type B')) +
  facet_grid(~ year) +
  labs(
    title = 'Southern Africa',
    y = 'Cases'
  )

NoAm / NoEu / OMP / TSA / EaAs / SA
```


# Epidemic Threshold

Attempt at serfling regression and epidemic threshold
```{r}
epi_threshold_df = flu_df %>% 
  filter(fluregion %in% c('North America', 'Northern Europe', 'Oceania Melanesia Polynesia', 'Temperate South America', 'Eastern Asia', 'Southern Africa')) %>% 
  mutate(theta = 2*week/52,
         sin_f1 = sin(theta),
         cos_f1 = cos(theta),
         week_2 = week^2,
         week_3 = week^3,
         week_4 = week^4,
         week_5 = week^5)

base_fit = epi_threshold_df %>%
  filter(fluregion == 'North America') %>% 
  lm(cases_by_100k ~ week + week_2 + week_3 + week_4 + week_5 + sin_f1 + cos_f1, data = ., na.action = na.exclude)

base_pred = epi_threshold_df %>%
  mutate(inf_a_prop = 0) %>%
  predict(base_fit, newdata = ., se.fit = TRUE, 
          interval = 'prediction', level = 0.90)

flu_fitted = epi_threshold_df %>%
  add_column(y0 = base_pred$fit[,1], y0_ul = base_pred$fit[,3])
```

2008-2014 Influenza Cases and Epidemic Threshold
```{r}
flu_fitted %>% 
  filter(fluregion == 'North America') %>% 
  ggplot(aes(x = date, y = cases_by_100k)) +
  geom_line() +
  geom_line(aes(x = date, y = y0_ul, color = 'Epidemic Threshold')) 
```

```{r}
flu_lm = function(df){
  
  function_fit = df %>%
  lm(cases_by_100k ~ week + week_2 + week_3 + week_4 + week_5 + sin_f1 + cos_f1, data = ., na.action = na.exclude) 
  
function_pred = df %>%
  mutate(inf_a_prop = 0) %>%
  predict(function_fit, newdata = ., se.fit = TRUE, 
          interval = 'prediction', level = 0.90)
  
  function_fitted = df %>%
  add_column(y0 = function_pred$fit[,1], y0_ul = function_pred$fit[,3])
}

serfling_df = epi_threshold_df %>% 
  group_by(fluregion) %>% 
  nest() %>% 
  mutate(map(data, ~flu_lm(.x))) %>% 
  unnest() 
  
```


```{r}
serfling_df %>% 
  ggplot(aes(x = date, y = cases_by_100k)) +
  geom_line() +
  geom_line(aes(x = date, y = y0_ul, color = 'Epidemic Threshold')) +
  facet_wrap(~fluregion)
```

